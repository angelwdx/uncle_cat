# DeepStory AI 项目文档

## 1. 项目概述

DeepStory AI 是一个基于 AI 驱动的智能小说创作平台，旨在帮助作者完成从创意构思到章节写作的全流程创作。该平台集成了 Gemini API，提供了完整的小说创作工作流，包括核心架构生成、角色设计、世界观构建、情节架构和章节写作等功能。

### 技术栈
- 前端框架：React 19
- 类型系统：TypeScript
- 构建工具：Vite
- UI 组件：lucide-react 图标库
- API 集成：支持 Gemini 和 OpenAI 兼容接口
- 状态管理：React 内置状态管理

## 2. 核心逻辑与功能模块

### 2.1 创作工作流

DeepStory AI 提供了一个结构化的八步创作流程，引导用户从初始创意到完整小说：

1. **创作初始化**：设置故事主题、题材、基调、结局、叙事视角、章节数和每章字数
2. **核心 DNA**：生成故事的核心公式，定义故事的基本框架
3. **角色动力学**：设计具有复杂关系和成长弧线的角色群
4. **世界观构建**：创建支撑故事发展的三维世界体系
5. **情节架构**：设计三幕式的情节结构
6. **章节蓝图**：生成详细的章节规划，包括每章的定位、作用和悬念设计
7. **角色状态库**：管理角色的动态状态和发展
8. **正文创作**：生成和编辑小说章节

### 2.2 核心功能

#### 2.2.1 AI 内容生成
- 基于预设提示词模板生成各种故事元素
- 支持自定义提示词和模板
- 支持多轮生成和修改
- 实现了自动重试机制，提高 API 调用成功率

#### 2.2.2 可视化展示
- **DNA 可视化**：以特殊格式展示故事核心 DNA
- **世界观可视化**：直观展示世界观构建内容
- **Markdown 渲染**：支持 Markdown 格式的内容展示

#### 2.2.3 章节写作工具
- 章节生成和重写功能
- 支持直接编辑章节内容
- 语音合成朗读功能
- 章节下载功能

#### 2.2.4 辅助创作工具
- **魔鬼编辑**：模拟专业编辑审阅，提供润色和重构建议
- **读者反馈模拟**：支持输入修改意见并重写章节
- **题材公式推荐**：根据章节内容推荐合适的题材公式

#### 2.2.5 状态管理
- 角色状态档案：跟踪角色的物品、能力、状态和关系
- 状态历史记录：保存不同章节的状态快照，支持回溯查看
- 上下文同步：根据章节内容自动更新全局摘要和角色状态

## 3. 参数设置与传递

### 3.1 核心配置参数

| 参数名 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| baseUrl | string | API 基础 URL | https://generativelanguage.googleapis.com |
| apiKey | string | API 密钥 | 无（需用户配置） |
| textModel | string | 文本生成模型 | gemini-2.5-flash |
| customTextModel | string | 自定义模型名称 | gpt-4o（当 textModel 为 custom 时） |

### 3.2 用户输入参数

| 参数名 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| topic | string | 故事主题 | 无 |
| genre | string | 故事题材 | 无 |
| tone | string | 故事基调 | 无 |
| ending | string | 结局类型 | 无 |
| perspective | string | 叙事视角 | 无 |
| numberOfChapters | number | 预计章节数 | 12 |
| wordCount | number | 每章字数 | 2000 |
| customRequirements | string | 自定义要求 | 无 |

### 3.3 数据传递流程

1. 用户在 UI 中输入参数 → 更新组件状态
2. 点击生成按钮 → 调用 `generateContent` 函数
3. 格式化提示词 → 调用 AI API
4. 处理 API 响应 → 更新 `generatedData` 状态
5. 重新渲染 UI，展示生成内容

### 3.4 状态管理

- 所有核心状态集中在 `App.tsx` 中管理
- 通过 props 将状态和回调函数传递给子组件
- 配置和自定义提示词保存在 `localStorage` 中，实现持久化存储

## 4. 项目结构

```
deepstory-build/
├── components/          # React 组件
│   ├── MarkdownViewer.tsx   # Markdown 渲染组件
│   ├── Modals.tsx           # 各种模态框组件
│   ├── StepCard.tsx         # 步骤卡片组件
│   ├── WritingStep.tsx      # 章节写作组件
│   ├── DnaVisualizer.tsx    # DNA 可视化组件
│   └── WorldVisualizer.tsx  # 世界观可视化组件
├── services/           # 服务层
│   └── apiService.ts        # API 调用和数据处理
├── App.tsx             # 主应用组件
├── constants.ts        # 常量和预设配置
├── types.ts            # 类型定义
├── index.html          # HTML 入口文件
├── package.json        # 项目配置和依赖
├── tsconfig.json       # TypeScript 配置
└── vite.config.ts      # Vite 配置
```

## 5. 核心 API 与函数

### 5.1 `generateContent`

**功能**：调用 AI API 生成内容

**参数**：
- `systemPrompt`：系统提示词，定义 AI 的角色和任务
- `userPrompt`：用户输入，提供具体的生成需求
- `config`：API 配置，包含基础 URL、密钥和模型

**返回值**：生成的文本内容

**实现细节**：
- 支持 Gemini 和 OpenAI 兼容接口
- 实现了指数退避重试机制（最多 5 次）
- 自动处理不同 API 的请求和响应格式

### 5.2 `formatPrompt`

**功能**：格式化提示词模板，替换变量

**参数**：
- `template`：提示词模板，包含占位符
- `variables`：变量对象，用于替换占位符

**返回值**：格式化后的提示词

### 5.3 `cleanAIResponse`

**功能**：清理 AI 响应，去除不必要的格式

**参数**：
- `text`：AI 生成的原始文本

**返回值**：清理后的文本

## 6. 优化建议

### 6.1 技术架构优化

1. **引入状态管理库**：
   - 目前所有状态集中在 `App.tsx`，随着功能扩展可能导致组件过于庞大
   - 建议引入 Zustand 或 Redux Toolkit 等轻量级状态管理库，提高代码可维护性

2. **实现 API 调用优化**：
   - 添加请求缓存机制，避免重复调用相同的提示词
   - 实现批量请求处理，减少 API 调用次数
   - 添加请求取消功能，防止用户频繁操作导致的无效请求

3. **优化数据持久化**：
   - 目前仅保存配置和自定义提示词，建议添加自动保存功能，定期保存创作进度
   - 实现云端同步功能，支持多设备访问

### 6.2 功能增强

1. **增强编辑功能**：
   - 添加语法检查和风格统一功能
   - 实现版本控制，支持查看和恢复历史版本
   - 添加协作功能，支持多人共同编辑

2. **扩展 AI 功能**：
   - 添加自动摘要生成功能
   - 实现情节一致性检查
   - 添加角色行为分析，确保角色行为符合设定

3. **优化移动端体验**：
   - 目前移动端体验较差，建议优化响应式设计
   - 添加移动端专属的交互方式

4. **添加更多可视化组件**：
   - 实现角色关系图可视化
   - 添加情节发展曲线展示
   - 实现章节间的关联可视化

### 6.3 性能优化

1. **优化渲染性能**：
   - 实现组件的懒加载和代码分割
   - 优化长文本的渲染性能，添加虚拟滚动
   - 减少不必要的重渲染

2. **优化 API 响应处理**：
   - 实现流式响应处理，提高用户体验
   - 优化大文本的处理和展示

3. **优化资源加载**：
   - 实现图标和资源的按需加载
   - 优化依赖项，减少打包体积

## 7. 总结

DeepStory AI 是一个功能完整、设计精良的智能小说创作平台，为作者提供了从创意构思到章节写作的全流程支持。平台采用了现代化的技术栈，具有良好的扩展性和可维护性。通过不断优化和增强功能，可以进一步提高平台的易用性和创作效率，为作者提供更好的创作体验。

该项目的核心优势在于：
- 完整的创作工作流，覆盖小说创作的各个阶段
- 强大的 AI 生成能力，支持多种内容生成和修改
- 丰富的可视化展示，提高内容的可读性和理解性
- 灵活的配置选项，支持自定义提示词和模板
- 良好的用户体验设计，操作简单直观

通过持续的优化和功能增强，DeepStory AI 有望成为作者创作小说的得力助手，提高创作效率和质量。